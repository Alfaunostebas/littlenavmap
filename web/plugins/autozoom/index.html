<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>unused plugin title (your plugin folders name is the title visible to the user)</title>
  </head>
  <body>
    <script>
      var originalZoom = -1;

      var zoomKnots = [0, 22, 55, 80, 110, 155, 200, 300, 400, 500, 750, 1500];   // reason: rest, taxi, takeoff (ga Cessna 172), intermediate, max (ga Icon A5), intermediate, max (ga DA 33), intermediate, cruise (airliner), max (airliner), for Mach >= 1 jets, for Mach >= 1 jets
      var zoomPowerForKnots = [-4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7];
      var zoomAltsAbvGrd = [0, 2000, 4000, 8000, 16000, 32000];
      var zoomPowerAddForAltsPerKnot = {
        "0": [0, 0, 0, 0, 0, 0],
        "22": [0, 0, 1, 1, 1, 1],
        "55": [0, 0, 1, 2, 2, 2],
        "80": [0, 0, 1, 2, 3, 3],
        "110": [0, 0, 1, 2, 3, 4],
        "155": [0, 0, 1, 2, 3, 3],
        "200": [0, 0, 1, 1, 2, 3],
        "300": [0, 0, 1, 1, 2, 3],
        "400": [0, 0, 1, 1, 2, 3],
        "500": [0, 0, 1, 1, 1, 2],
        "750": [0, 0, 1, 1, 1, 1],
        "1500": [0, 0, 0, 0, 0, 0]
      };
      var zoomWaitForKnots = [5, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1];    // refresh in seconds

      var contentIframe;
      var enabled = true;
      var timeout = null;
      var running = true;

      function stop() {
        contentIframe.removeEventListener("load", checkIframeSrc);
        clearTimeout(timeout);
        running = false;
        restoreValuesPerhapsOverridden();
      }

      function checkIframeSrc() {
        enabled = contentIframe.contentWindow.location.href.endsWith("/map.html");
        if(enabled) {
          autozoom();
        } else {
          clearTimeout(timeout);
        }
      }

      function saveValuesToGetOverridden() {
        fetch("/api/ui/info").then(function(response) {
          if(response.ok) {
            return response.json();
          } else {
            originalZoom = -1;
          }
        }).then(function(json) {
          originalZoom = Math.log(json.zoom_web) / Math.log(2);
        });
      }

      function restoreValuesPerhapsOverridden() {
        originalZoom > -1 ? fetch("/mapimage?format=jpg&quality=1&width=1&height=1&distance=" + Math.pow(2, originalZoom) + "&session&cmd=" + Math.random()) : 0;
      }

      function autozoom() {
        fetch("/api/sim/info").then(function(response) {
          if(response.ok && running && enabled) {
            return response.json();
          } else {
            if(!response.ok) {
              timeout = setTimeout(autozoom, 10000);
            }
            return Promise.reject();
          }
        }).then(function(json) {
          if(json.active) {
            var speed = json.ground_speed;
            var alt = json.altitude_above_ground;
            var i=0;
            while(i < zoomKnots.length && speed >= zoomKnots[i]) {
              i++;
            }
            var speedIndex = i;
            var zoomLookup = "" + zoomKnots[i];
            var zoomPower = zoomPowerForKnots[i - 1];
            i=0;
            while(i < zoomAltsAbvGrd.length && alt >= zoomAltsAbvGrd[i]) {
              i++;
            }
            var zoomPowerAdd = zoomPowerAddForAltsPerKnot[zoomLookup][i - 1];
            fetch("/mapimage?format=jpg&quality=1&width=1&height=1&distance=" + Math.pow(2, zoomPower + zoomPowerAdd) + "&session&cmd=" + Math.random()).then(function() {
              timeout = setTimeout(autozoom, zoomWaitForKnots[speedIndex - 1] * 1000);
            });
          } else {
            timeout = setTimeout(autozoom, 10000);
          }
        }).catch(function(){});
      }

      function init(callback, version) {
        if(version !== 1) {
          if(!confirm("New map version running possibly unsupported.\n\nDo you like to let run this plugin anyway?")) {
            throw "aborted by user";
          }
        }

        var returned_Value = callback(callback.TYPE_BACKGROUND, stop);
        returned_Value.disable_AccessPrevention();

        contentIframe = parent.document.querySelector("iframe[name=contentiframe]");
        contentIframe.addEventListener("load", checkIframeSrc);

        saveValuesToGetOverridden();

        checkIframeSrc();
      }
    </script>
  </body>
</html>